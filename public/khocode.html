<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>N·∫•m Vi·ªát ‚Äî Di·ªÖn ƒë√†n</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <style>
        /* small helper for line clamp if not using plugin */
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.45);
        }

        body {
            background-image:
                linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.3)),
                url('/hinh/mushroom.png');
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* Th√™m style ƒë·ªÉ l√†m n·ªïi b·∫≠t danh m·ª•c ƒë∆∞·ª£c ch·ªçn */
        .category-item {
            cursor: pointer;
            padding: 4px 0;
            transition: color 0.2s;
        }

        .category-item:hover {
            color: #10B981;
            /* emerald-500 */
        }

        .category-item.active {
            font-weight: 600;
            color: #065F46;
            /* emerald-900 */
            border-left: 3px solid #047857;
            /* emerald-700 */
            padding-left: 10px;
        }
    </style>
</head>

<body class="min-h-screen font-sans">
    <header class="bg-emerald-700 text-white p-4 shadow-md">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" height="32" width="32"
                    viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                    <path fill="#ffffff"
                        d="M112 256C112 167.6 183.6 96 272 96C319.1 96 361.4 116.4 390.7 148.7C401.3 145.6 412.5 144 424 144C490.3 144 544 197.7 544 264C544 277.2 541.9 289.9 537.9 301.8C579.5 322.9 608 366.1 608 416C608 486.7 550.7 544 480 544L176 544C96.5 544 32 479.5 32 400C32 343.2 64.9 294.1 112.7 270.6C112.3 265.8 112 260.9 112 256zM272 144C210.1 144 160 194.1 160 256C160 264.4 160.9 272.6 162.7 280.5C165.4 292.6 158.4 304.8 146.6 308.6C107.9 321 80 357.3 80 400C80 453 123 496 176 496L480 496C524.2 496 560 460.2 560 416C560 378.6 534.3 347.1 499.5 338.4C492 336.5 485.9 331.2 483 324.1C480.1 317 480.9 308.9 485 302.4C492 291.3 496 278.2 496 264.1C496 224.3 463.8 192.1 424 192.1C412.9 192.1 402.5 194.6 393.2 199C382.7 204 370.1 200.7 363.4 191.2C343.1 162.6 309.7 144.1 272.1 144.1z" />
                </svg>
                <h1 class="text-xl font-bold">N·∫•m Vi·ªát ‚Äî Di·ªÖn ƒë√†n</h1>
            </div>

            <div id="auth-controls" class="flex items-center gap-3">
                <button id="btn-open-register" class="bg-white text-emerald-700 px-3 py-1 rounded shadow">
                    ƒêƒÉng k√Ω
                </button>
                <button id="btn-open-login" class="bg-white text-emerald-700 px-3 py-1 rounded shadow">
                    ƒêƒÉng nh·∫≠p
                </button>
                <button id="btn-logout"
                    class="hidden 
    bg-red-600 text-white      hover:bg-red-700           px-4 py-2 rounded-lg       font-semibold shadow-md    transition duration-300    ">
                    ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-6 grid grid-cols-1 md:grid-cols-4 gap-6">
        <aside class="md:col-span-1 hidden md:block">
            <div class="bg-white p-4 rounded shadow">
                <h2 class="font-semibold text-emerald-700 mb-3">Danh m·ª•c</h2>
                <ul id="category-list" class="space-y-2 text-sm text-gray-700">
                    <li class="flex items-center gap-2 category-item active" data-category="all">
                        <span>üì∞</span> T·∫•t c·∫£ b√†i vi·∫øt
                    </li>
                    <li class="flex items-center gap-2 category-item" data-category="growing">
                        <span>üçÑ</span> M·∫πo tr·ªìng
                    </li>
                    <li class="flex items-center gap-2 category-item" data-category="identification">
                        <span>üî¨</span> Nh·∫≠n d·∫°ng
                    </li>
                    <li class="flex items-center gap-2 category-item" data-category="cooking">
                        <span>üç≥</span> ·∫®m th·ª±c
                    </li>
                    <li class="flex items-center gap-2 category-item" data-category="general">
                        <span>üí¨</span> Th·∫£o lu·∫≠n
                    </li>
                </ul>
            </div>
            <div class="bg-emerald-700 text-white p-4 rounded shadow mt-4">
                <p class="text-sm">ƒê√£ c√≥ <span id="stat-users" class="font-semibold">‚Äî</span> th√†nh vi√™n</p>
                <p class="text-sm mt-2">T·ªïng b√†i vi·∫øt: <span id="stat-posts" class="font-semibold">‚Äî</span></p>
            </div>
        </aside>

        <section class="md:col-span-3 p-4 md:p-0">
            <div
                class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 border-b border-gray-700 pb-4">

                <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-4 sm:mb-0">
                    B·∫£ng tin ‚ú®
                </h1>

                <div class="flex items-center gap-3 w-full sm:w-auto">
                    <div class="relative w-full sm:w-64">
                        <input id="searchInput" type="text" placeholder="T√¨m ch·ªß ƒë·ªÅ, t√°c gi·∫£..." class="w-full pl-4 pr-10 py-2.5 
                           border border-gray-600 rounded-xl 
                           bg-gray-800 text-white 
                           focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 
                           transition duration-200" />
                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                            üîç
                        </span>
                    </div>

                    <button id="btn-open-create" class="bg-emerald-600 text-white 
                       hover:bg-emerald-500 
                       px-4 py-2.5 rounded-xl shadow-lg 
                       font-semibold 
                       hidden md:inline-flex 
                       items-center transition duration-200">
                        + T·∫°o b√†i
                    </button>
                </div>
            </div>
            <div id="feed" class="space-y-6">
            </div>

            <div class="text-center mt-8">
                <button id="btn-load-more" class="px-6 py-2 bg-gray-700 text-white rounded-full 
                       hover:bg-gray-600 transition duration-200 
                       font-semibold">
                    T·∫£i th√™m b√†i vi·∫øt
                </button>
            </div>
        </section>

    </main>

    <div id="modal-post" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-xl p-6">
            <h3 id="modal-post-title" class="text-lg font-semibold mb-3">T·∫°o b√†i vi·∫øt</h3>
            <form id="form-post" class="space-y-3">
                <input id="post-title" class="w-full border px-3 py-2 rounded" placeholder="Ti√™u ƒë·ªÅ" required />
                <select id="post-category" class="w-full border px-3 py-2 rounded">
                    <option value="growing">ChƒÉm S√≥c</option>
                    <option value="identification">Nh·∫≠n D·∫°ng</option>
                    <option value="cooking">·∫®m Th·ª±c</option>
                    <option value="general">Th·∫£o Lu·∫≠n Chung</option>
                </select>
                <textarea id="post-content" rows="6" class="w-full border px-3 py-2 rounded"
                    placeholder="  N·ªôi dung b√†i vi·∫øt ..." required>


                </textarea>

                <div class="flex justify-end gap-2">
                    <button type="button" id="btn-cancel-post" class="px-4 py-2 bg-gray-200 rounded">H·ªßy</button>
                    <button type="submit" class="px-4 py-2 bg-emerald-700 text-white rounded">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-login" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-3">ƒêƒÉng nh·∫≠p</h3>
            <form id="form-login" class="space-y-3">
                <input id="login-email" type="email" class="w-full border px-3 py-2 rounded" placeholder="Email"
                    required />
                <input id="login-pass" type="password" class="w-full border px-3 py-2 rounded" placeholder="M·∫≠t kh·∫©u"
                    required />
                <div class="flex justify-end gap-2">
                    <button type="button" id="btn-cancel-login" class="px-4 py-2 bg-gray-200 rounded">H·ªßy</button>
                    <button type="submit" class="px-4 py-2 bg-emerald-700 text-white rounded">ƒêƒÉng nh·∫≠p</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-register" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-3">ƒêƒÉng k√Ω</h3>
            <form id="form-register" class="space-y-3">
                <input id="reg-username" type="text" class="w-full border px-3 py-2 rounded" placeholder="T√™n hi·ªÉn th·ªã"
                    required />
                <input id="reg-email" type="email" class="w-full border px-3 py-2 rounded" placeholder="Email"
                    required />
                <input id="reg-pass" type="password" class="w-full border px-3 py-2 rounded" placeholder="M·∫≠t kh·∫©u"
                    required />
                <div class="flex justify-end gap-2">
                    <button type="button" id="btn-cancel-register" class="px-4 py-2 bg-gray-200 rounded">H·ªßy</button>
                    <button type="submit" class="px-4 py-2 bg-emerald-700 text-white rounded">ƒêƒÉng k√Ω</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 hidden z-50">
        <div id="toast-body" class="bg-gray-800 text-white px-4 py-2 rounded shadow"></div>
    </div>

    <script>
        /* =========================
            Configuration
            ========================= */
        // works with express serving public folder as static files as well as API
        // khu v·ª±c l√†m vi·ªác v·ªõi express ph·ª•c v·ª• th∆∞ m·ª•c c√¥ng c·ªông d∆∞·ªõi d·∫°ng t·ªáp tƒ©nh c≈©ng nh∆∞ API
        // v√≠ d·ª•: n·∫øu trang web ·ªü https://namviet.example th√¨ API s·∫Ω ·ªü https://localhost:5000
        const API_BASE = window.location.origin + "/api";
        const POSTS_API = API_BASE + "/posts";
        const AUTH_API = API_BASE + "/auth";

        // C·∫•u h√¨nh √°nh x·∫° danh m·ª•c cho hi·ªÉn th·ªã
        const CATEGORY_MAP = {
            growing: { name: "ChƒÉm s√≥c", color: "bg-green-100 text-green-700", emoji: "üçÑ" },
            identification: { name: "Nh·∫≠n D·∫°ng", color: "bg-blue-100 text-blue-700", emoji: "üî¨" },
            cooking: { name: "·∫®m Th·ª±c", color: "bg-red-100 text-red-700", emoji: "üç≥" },
            general: { name: "Th·∫£o Lu·∫≠n Chung", color: "bg-gray-200 text-gray-700", emoji: "üí¨" }
        };

        /* =========================
            State
            ========================= */
        let state = {
            posts: [],
            page: 1,
            pageSize: 10,
            token: localStorage.getItem("token") || null,
            editingPostId: null,
            // Th√™m state cho danh m·ª•c v√† t√¨m ki·∫øm
            currentCategory: "all", // M·∫∑c ƒë·ªãnh l√† 'all'
            currentSearch: "",
        };

        /* =========================
            Utilities
            ========================= */
        function showToast(msg, timeout = 3000) {
            const toast = document.getElementById("toast");
            const body = document.getElementById("toast-body");
            body.textContent = msg;
            toast.classList.remove("hidden");
            setTimeout(() => toast.classList.add("hidden"), timeout);
        }

        function authHeaders() {
            return state.token ? { "Authorization": "Bearer " + state.token } : {};
        }

        /**
         * L·∫•y t√™n hi·ªÉn th·ªã c·ªßa danh m·ª•c t·ª´ key
         * @param {string} key - 'growing', 'identification', etc.
         * @returns {{name: string, color: string, emoji: string}}
         */
        function getCategoryDetails(key) {
            return CATEGORY_MAP[key] || { name: "Kh√¥ng x√°c ƒë·ªãnh", color: "bg-yellow-100 text-yellow-700", emoji: "‚ùì" };
        }

        /* =========================
            Load / Render posts
            ========================= */
        async function loadPosts(replace = true) {
            try {
                // Th√™m tham s·ªë category v√†o URL n·∫øu kh√¥ng ph·∫£i l√† 'all'
                const categoryParam = state.currentCategory !== 'all' ? `&category=${state.currentCategory}` : '';
                const url = `${POSTS_API}?page=${state.page}&limit=${state.pageSize}${categoryParam}`;

                const res = await fetch(url);
                if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i b√†i vi·∫øt");
                const posts = await res.json();

                // Gi·∫£ ƒë·ªãnh d·ªØ li·ªáu post t·ª´ API thi·∫øu tr∆∞·ªùng 'category', th√™m ng·∫´u nhi√™n cho m·ª•c ƒë√≠ch hi·ªÉn th·ªã
                const postsWithCategory = posts.map(p => {
                    if (!p.category) {
                        const keys = Object.keys(CATEGORY_MAP);
                        p.category = keys[Math.floor(Math.random() * keys.length)]; // Th√™m category ng·∫´u nhi√™n
                    }
                    return p;
                });
                // Sau khi ƒë√£ ƒë·∫£m b·∫£o API tr·∫£ v·ªÅ tr∆∞·ªùng 'category' ch√≠nh x√°c,
                // ta ch·ªâ c·∫ßn s·ª≠ d·ª•ng m·∫£ng posts tr·ª±c ti·∫øp.

                if (replace) state.posts = posts;
                else state.posts = state.posts.concat(posts);
                //if (replace) state.posts = postsWithCategory;
                //else state.posts = state.posts.concat(postsWithCategory);




                renderFeed();
                // stats
                document.getElementById("stat-posts").textContent = state.posts.length;
            } catch (err) {
                console.error(err);
                showToast("L·ªói t·∫£i b√†i vi·∫øt");
            }
        }

        //         // UHMMM FIX 24/10/2025
        //         /* =========================
        //     CATEGORY BUTTON LOGIC
        // ========================= */
        // document.addEventListener("DOMContentLoaded", () => {
        //   const buttons = document.querySelectorAll(".category-btn");

        //   buttons.forEach(btn => {
        //     btn.addEventListener("click", e => {
        //       // X√≥a highlight t·∫•t c·∫£ n√∫t
        //       buttons.forEach(b =>
        //         b.classList.remove("ring", "ring-offset-2", "ring-green-400", "bg-opacity-90")
        //       );

        //       // C·∫≠p nh·∫≠t danh m·ª•c hi·ªán t·∫°i
        //       const category = e.currentTarget.dataset.category || "all";
        //       state.currentCategory = category;

        //       // L·ªçc v√† hi·ªÉn th·ªã l·∫°i b√†i vi·∫øt
        //       filterAndRenderFeed();

        //       // Highlight n√∫t ƒëang ch·ªçn
        //       e.currentTarget.classList.add("ring", "ring-offset-2", "ring-green-400", "bg-opacity-90");
        //     });
        //   });

        //   // M·∫∑c ƒë·ªãnh highlight n√∫t ‚ÄúT·∫•t c·∫£‚Äù
        //   const defaultBtn = document.querySelector('[data-category="all"]');
        //   if (defaultBtn) {
        //     defaultBtn.classList.add("ring", "ring-offset-2", "ring-green-400", "bg-opacity-90");
        //   }
        // });

        // // END FIX


        // /**
        //  * L·ªçc b√†i vi·∫øt d·ª±a tr√™n t√¨m ki·∫øm v√† danh m·ª•c (s·ª≠ d·ª•ng state.posts hi·ªán t·∫°i)
        //  */
        // function filterAndRenderFeed() {
        //   const feed = document.getElementById("feed");

        //   // L·∫•y gi√° tr·ªã t√¨m ki·∫øm & danh m·ª•c hi·ªán t·∫°i
        //   const q = state.currentSearch.toLowerCase().trim();
        //   const selectedCategory = state.currentCategory || "all";

        //   // 1Ô∏è‚É£ L·ªçc theo danh m·ª•c
        //   let filteredPosts = state.posts;
        //   if (selectedCategory !== "all") {
        //     filteredPosts = filteredPosts.filter(
        //       p => (p.category || "").toLowerCase() === selectedCategory.toLowerCase()
        //     );
        //   }

        //   // 2Ô∏è‚É£ L·ªçc theo t·ª´ kh√≥a (t√™n b√†i vi·∫øt, n·ªôi dung, ho·∫∑c t√™n t√°c gi·∫£)
        //   if (q) {
        //     filteredPosts = filteredPosts.filter(p =>
        //       (p.title + " " + p.content + " " + (p.author?.username || "")).toLowerCase().includes(q)
        //     );
        //   }

        //   // 3Ô∏è‚É£ Hi·ªÉn th·ªã n·∫øu c√≥ k·∫øt qu·∫£ ho·∫∑c th√¥ng b√°o n·∫øu kh√¥ng c√≥
        //   if (!filteredPosts.length) {
        //     feed.innerHTML = `
        //       <div class="bg-white p-6 rounded shadow text-center text-gray-600">
        //         Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†o ph√π h·ª£p.
        //       </div>`;
        //     return;
        //   }

        //   feed.innerHTML = filteredPosts.map(postCardHTML).join("");
        // }

        // /**
        //  * Gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch ‚Äî gi·ªù ch·ªâ c·∫ßn g·ªçi filterAndRenderFeed()
        //  */
        // function renderFeed() {
        //   filterAndRenderFeed();
        // }


        /**
         * L·ªçc b√†i vi·∫øt d·ª±a tr√™n t√¨m ki·∫øm v√† danh m·ª•c (s·ª≠ d·ª•ng state.posts hi·ªán t·∫°i)
         */
        function filterAndRenderFeed() {
            const feed = document.getElementById("feed");

            // 1. L·ªçc theo t√¨m ki·∫øm (t·ª´ kh√≥a)
            const q = state.currentSearch.toLowerCase();
            const filteredBySearch = state.posts.filter(p =>
                (p.title + " " + p.content + " " + (p.author?.username || "")).toLowerCase().includes(q)
            );

            // 2. L·ªçc theo danh m·ª•c (ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü loadPosts n·∫øu kh√¥ng ph·∫£i 'all', nh∆∞ng c·∫ßn l·ªçc l·∫°i n·∫øu ch·ªâ t√¨m ki·∫øm local)
            // L∆∞u √Ω: N·∫øu mu·ªën l·ªçc theo danh m·ª•c ngay c·∫£ khi ƒë√£ t·∫£i h·∫øt, b·∫°n c√≥ th·ªÉ th√™m logic l·ªçc category ·ªü ƒë√¢y
            // Tuy nhi√™n, v√¨ loadPosts ƒë√£ th·ª±c hi·ªán vi·ªác n√†y (th√¥ng qua API), ta ch·ªâ c·∫ßn render filteredBySearch

            if (!filteredBySearch.length) {
                feed.innerHTML = `<div class="bg-white p-6 rounded shadow text-center text-gray-600">Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†o ph√π h·ª£p.</div>`;
                return;
            }
            feed.innerHTML = filteredBySearch.map(postCardHTML).join("");
        }

        // ƒê·ªïi t√™n h√†m renderFeed th√†nh filterAndRenderFeed
        function renderFeed() {
            filterAndRenderFeed();
        }

        function postCardHTML(p) {
            // sanitize simple (basic) - in production use proper sanitizer
            const title = escapeHtml(p.title);
            const content = escapeHtml(p.content);
            const author = p.author?.username || "·∫®n danh";
            const created = new Date(p.createdAt).toLocaleString();
            const likes = Array.isArray(p.likes) ? p.likes.length : 0;
            const comments = Array.isArray(p.comments) ? p.comments.length : 0;

            // L·∫•y th√¥ng tin danh m·ª•c
            const category = getCategoryDetails(p.category);

            // show edit/delete buttons only if current user is author or admin
            let actions = "";
            try {
                const payload = parseJwt(state.token);
                if (payload && (payload.id === (p.author?._id || p.author) || payload.role === "admin")) {
                    actions = `
        <button data-id="${p._id}" class="btn-edit text-sm text-emerald-700 px-2 py-1 border rounded">S·ª≠a</button>
        <button data-id="${p._id}" class="btn-delete text-sm text-red-600 px-2 py-1 border rounded">X√≥a</button>
      `;
                }
            } catch (e) { /* ignore */ }

            return `
    <article class="bg-white p-5 rounded-lg shadow">
      <div class="flex justify-between items-start">
        <h3 class="text-lg font-semibold">${title}</h3>
        <div class="flex gap-2">${actions}</div>
      </div>
      
      <span class="inline-block ${category.color} text-xs font-medium px-2.5 py-0.5 rounded-full mt-1">
        ${category.emoji} ${category.name}
      </span>

      <p class="mt-3 text-gray-700 line-clamp-3"> ${content}</p>
      <div class="mt-4 flex items-center justify-between text-sm text-gray-500">
        <div>üë§ ${author} ‚Ä¢ ${created}</div>
        <div class="flex items-center gap-4">
            <div><i class="fa-solid fa-heart" style="color: #ff0000;">
                <i class="fa-regular fa-heart" style="color: #f20202;"></i>
                </i> ${likes}
            </div>
          
          <div><i class="fa-regular fa-comment" style="color: #74C0FC;"></i> ${comments}</div>
        </div>
      </div>
    </article>
  `;
        }

        /* =========================
            Helpers: sanitize + jwt parse
            ========================= */
        function escapeHtml(str = "") {
            return String(str)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;");
        }
        function parseJwt(token) {
            if (!token) return null;
            const parts = token.split(".");
            if (parts.length !== 3) return null;
            try {
                const payload = JSON.parse(atob(parts[1]));
                return payload;
            } catch (e) { return null; }
        }


        /* =========================
   Create / Edit Post Modal
========================= */
        function openCreateModal() {
            state.editingPostId = null;
            document.getElementById("modal-post").classList.remove("hidden");
            document.getElementById("modal-post-title").textContent = "T·∫°o b√†i vi·∫øt";
            document.getElementById("post-title").value = "";
            document.getElementById("post-content").value = "";

            document.getElementById("post-category").value = "general";
        }

        function openEditModal(post) {
            state.editingPostId = post._id;
            document.getElementById("modal-post").classList.remove("hidden");
            document.getElementById("modal-post-title").textContent = "Ch·ªânh s·ª≠a b√†i vi·∫øt";
            document.getElementById("post-title").value = post.title;
            document.getElementById("post-content").value = post.content;
            document.getElementById("post-category").value = post.category || "general";
        }

        // Hi·ªÉn th·ªã n√∫t m·ªü modal
        const btnOpen = document.getElementById("btn-open-create");
        if (btnOpen) {
            btnOpen.classList.remove("hidden");
            btnOpen.addEventListener("click", () => openCreateModal());
        }

        // H·ªßy modal
        document.getElementById("btn-cancel-post").addEventListener("click", () => {
            document.getElementById("modal-post").classList.add("hidden");
        });

        // Khi ch·ªçn danh m·ª•c ‚Üí t·ª± ƒë·ªông hi·ªÉn th·ªã g·ª£i √Ω trong n·ªôi dung
        // const categorySelect = document.getElementById("post-category");
        // const contentTextarea = document.getElementById("post-content");

        // if (categorySelect && contentTextarea) {
        //     categorySelect.addEventListener("change", () => {
        //         const catText = categorySelect.options[categorySelect.selectedIndex].text;
        //         // N·∫øu textarea ƒëang tr·ªëng ho·∫∑c ch·ªâ ch·ª©a d√≤ng c≈© th√¨ thay th·∫ø
        //         if (!contentTextarea.value.trim() || contentTextarea.value.startsWith("Danh m·ª•c:")) {
        //             contentTextarea.value = `Danh m·ª•c: ${catText}\n\n`;
        //         }
        //     });
        // }

        // Submit form
        document.getElementById("form-post").addEventListener("submit", async (e) => {
            e.preventDefault();

            const title = document.getElementById("post-title").value.trim();
            const content = document.getElementById("post-content").value.trim();
            const category = document.getElementById("post-category").value;

            if (!title || !content) { showToast("Vui l√≤ng ƒëi·ªÅn ti√™u ƒë·ªÅ v√† n·ªôi dung"); return; }
            if (!state.token) { showToast("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o b√†i"); return; }

            try {
                const postData = { title, content, category };
                let res;

                if (state.editingPostId) {
                    // C·∫≠p nh·∫≠t b√†i vi·∫øt
                    res = await fetch(`${POSTS_API}/${state.editingPostId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json", ...authHeaders() },
                        body: JSON.stringify(postData)
                    });
                } else {
                    // T·∫°o b√†i m·ªõi
                    res = await fetch(POSTS_API, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", ...authHeaders() },
                        body: JSON.stringify(postData)
                    });
                }

                const data = await res.json();
                if (!res.ok) { showToast(data.message || "L·ªói server"); return; }

                document.getElementById("modal-post").classList.add("hidden");
                showToast(state.editingPostId ? "C·∫≠p nh·∫≠t b√†i th√†nh c√¥ng" : "T·∫°o b√†i th√†nh c√¥ng");

                // L√†m m·ªõi danh s√°ch b√†i vi·∫øt
                state.page = 1;
                await loadPosts(true);
            } catch (err) {
                console.error(err);
                showToast("L·ªói khi g·ª≠i b√†i");
            }
        });

        // /* =========================
        //     Create post
        //     ========================= */
        // function openCreateModal() {
        //     state.editingPostId = null;
        //     document.getElementById("modal-post").classList.remove("hidden");
        //     document.getElementById("modal-post-title").textContent = "T·∫°o b√†i vi·∫øt";
        //     document.getElementById("post-title").value = "";
        //     document.getElementById("post-content").value = "";
        //     // ƒê·∫∑t category m·∫∑c ƒë·ªãnh
        //     document.getElementById("post-category").value = "general";
        // }
        // function openEditModal(post) {
        //     state.editingPostId = post._id;
        //     document.getElementById("modal-post").classList.remove("hidden");
        //     document.getElementById("modal-post-title").textContent = "Ch·ªânh s·ª≠a b√†i vi·∫øt";
        //     document.getElementById("post-title").value = post.title;
        //     document.getElementById("post-content").value = post.content;
        //     // ƒê·∫∑t category cho ch·ªânh s·ª≠a
        //     document.getElementById("post-category").value = post.category || "general";
        // }

        // document.getElementById("btn-open-create").addEventListener("click", () => openCreateModal());
        // document.getElementById("btn-open-create")?.classList.remove("hidden"); // show on larger screens

        // document.getElementById("btn-cancel-post").addEventListener("click", () => {
        //     document.getElementById("modal-post").classList.add("hidden");
        // });

        // document.getElementById("form-post").addEventListener("submit", async (e) => {
        //     e.preventDefault();
        //     const title = document.getElementById("post-title").value.trim();
        //     const content = document.getElementById("post-content").value.trim();

        //     const category = document.getElementById("post-category").value; // L·∫•y danh m·ª•c

        //     if (!title || !content) { showToast("Vui l√≤ng ƒëi·ªÅn ti√™u ƒë·ªÅ v√† n·ªôi dung"); return; }
        //     if (!state.token) { showToast("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o b√†i"); return; }

        //     try {
        //         let res;
        //         const postData = { title, content, category }; // Th√™m category v√†o d·ªØ li·ªáu g·ª≠i ƒëi

        //         if (state.editingPostId) {
        //             // edit
        //             res = await fetch(`${POSTS_API}/${state.editingPostId}`, {
        //                 method: "PUT",
        //                 headers: { "Content-Type": "application/json", ...authHeaders() },
        //                 body: JSON.stringify(postData)
        //             });
        //         } else {
        //             // create
        //             res = await fetch(POSTS_API, {
        //                 method: "POST",
        //                 headers: { "Content-Type": "application/json", ...authHeaders() },
        //                 body: JSON.stringify(postData)
        //             });
        //         }

        //         const data = await res.json();
        //         if (!res.ok) { showToast(data.message || "L·ªói server"); return; }

        //         document.getElementById("modal-post").classList.add("hidden");
        //         showToast(state.editingPostId ? "C·∫≠p nh·∫≠t b√†i th√†nh c√¥ng" : "T·∫°o b√†i th√†nh c√¥ng");

        //         // Sau khi t·∫°o/s·ª≠a, t·∫£i l·∫°i b√†i vi·∫øt
        //         state.page = 1; // reset page count
        //         await loadPosts(true);
        //     } catch (err) {
        //         console.error(err);
        //         showToast("L·ªói khi g·ª≠i b√†i");
        //     }
        // });

        /* =========================
            Delete post
            ========================= */
        document.addEventListener("click", async (e) => {
            if (e.target.matches(".btn-delete")) {
                const id = e.target.dataset.id;
                if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i n√†y?")) return;
                try {
                    const res = await fetch(`${POSTS_API}/${id}`, {
                        method: "DELETE",
                        headers: { ...authHeaders() }
                    });
                    const data = await res.json();
                    if (!res.ok) { showToast(data.message || "Kh√¥ng th·ªÉ x√≥a"); return; }
                    showToast("ƒê√£ x√≥a b√†i");
                    await loadPosts(true);
                } catch (err) {
                    console.error(err);
                    showToast("L·ªói khi x√≥a b√†i");
                }
            }

            if (e.target.matches(".btn-edit")) {
                const id = e.target.dataset.id;
                const post = state.posts.find(p => p._id === id);
                if (!post) { showToast("B√†i kh√¥ng t·ªìn t·∫°i"); return; }
                openEditModal(post);
            }

            // X·ª≠ l√Ω l·ªçc danh m·ª•c t·ª´ sidebar
            if (e.target.closest(".category-item")) {
                const item = e.target.closest(".category-item");
                const categoryKey = item.dataset.category;

                // Ch·ªâ l√†m vi·ªác n·∫øu danh m·ª•c thay ƒë·ªïi
                if (categoryKey !== state.currentCategory) {
                    state.currentCategory = categoryKey;
                    state.page = 1; // Reset trang khi ƒë·ªïi danh m·ª•c

                    // C·∫≠p nh·∫≠t giao di·ªán sidebar
                    document.querySelectorAll(".category-item").forEach(el => el.classList.remove("active"));
                    item.classList.add("active");

                    // T·∫£i b√†i vi·∫øt m·ªõi
                    await loadPosts(true);

                    // X√≥a n·ªôi dung t√¨m ki·∫øm ƒë·ªÉ tr√°nh xung ƒë·ªôt
                    document.getElementById("searchInput").value = "";
                    state.currentSearch = "";
                }
            }
        });

        /* =========================
            Auth: login / register 
            ========================= */
        document.getElementById("btn-open-login").addEventListener("click", () => {
            document.getElementById("modal-login").classList.remove("hidden");
        });
        document.getElementById("btn-cancel-login").addEventListener("click", () => {
            document.getElementById("modal-login").classList.add("hidden");
        });
        document.getElementById("btn-open-register").addEventListener("click", () => {
            document.getElementById("modal-register").classList.remove("hidden");
        });
        document.getElementById("btn-cancel-register").addEventListener("click", () => {
            document.getElementById("modal-register").classList.add("hidden");
        });

        document.getElementById("form-login").addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-pass").value;
            try {
                const res = await fetch(`${AUTH_API}/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (!res.ok) { showToast(data.message || "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i"); return; }
                // Expect token in data.token or data.token
                const token = data.token || data.token;
                state.token = token;
                localStorage.setItem("token", token);
                document.getElementById("modal-login").classList.add("hidden");
                updateAuthUI();
                showToast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng");
            } catch (err) {
                console.error(err);
                showToast("L·ªói khi ƒëƒÉng nh·∫≠p");
            }
        });




        document.getElementById("form-register").addEventListener("submit", async (e) => {
            e.preventDefault();
            const username = document.getElementById("reg-username").value;
            const email = document.getElementById("reg-email").value;
            const password = document.getElementById("reg-pass").value;
            try {
                const res = await fetch(`${AUTH_API}/register`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, email, password })
                });
                const data = await res.json();
                if (!res.ok) { showToast(data.message || "ƒêƒÉng k√Ω th·∫•t b·∫°i"); return; }
                const token = data.token || data.token;
                state.token = token;
                localStorage.setItem("token", token);
                document.getElementById("modal-register").classList.add("hidden");
                updateAuthUI();
                showToast("ƒêƒÉng k√Ω th√†nh c√¥ng");
            } catch (err) {
                console.error(err);
                showToast("L·ªói khi ƒëƒÉng k√Ω");
            }
        });

        /* =========================
            Logout / UI
            ========================= */
        document.getElementById("btn-logout").addEventListener("click", () => {
            localStorage.removeItem("token");
            state.token = null;
            updateAuthUI();
            showToast("ƒê√£ ƒëƒÉng xu·∫•t");
        });

        function updateAuthUI() {
            const loggedIn = !!state.token;
            document.getElementById("btn-open-login").classList.toggle("hidden", loggedIn);
            document.getElementById("btn-open-register").classList.toggle("hidden", loggedIn);
            document.getElementById("btn-logout").classList.toggle("hidden", !loggedIn);
            document.getElementById("btn-open-create").classList.toggle("hidden", !loggedIn);
        }

        /* =========================
            Init
            ========================= */
        (function init() {
            updateAuthUI();
            loadPosts(true);

            // load more
            document.getElementById("btn-load-more").addEventListener("click", async () => {
                state.page++;
                await loadPosts(false);
            });

            // search handler (simple)
            document.getElementById("searchInput").addEventListener("input", (e) => {
                state.currentSearch = e.target.value.trim();
                filterAndRenderFeed(); // Ch·ªâ l·ªçc tr√™n d·ªØ li·ªáu hi·ªán t·∫°i
            });
            // close modals when clicking backdrop
            document.querySelectorAll('[id^="modal-"]').forEach(mod => {
                mod.addEventListener("click", (ev) => {
                    if (ev.target === mod) mod.classList.add("hidden");
                });
            });
        })();
    </script>
</body>

</html>