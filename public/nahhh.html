<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Náº¥m Viá»‡t â€” Diá»…n Ä‘Ã n</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <style>
    .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .modal-backdrop { background: rgba(0,0,0,0.45); }
    body {
      background-image:
        linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.3)),
        url('/hinh/mushroom.png');
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .category-item { cursor: pointer; padding: 4px 0; transition: color 0.15s; }
    .category-item:hover { color: #10B981; }
    .category-item.active { font-weight: 600; color: #065F46; border-left: 3px solid #047857; padding-left: 10px; }
    /* small helper to make modal content scrollable on small screens */
    .modal-inner { max-height: 85vh; overflow:auto; }
  </style>
</head>
<body class="min-h-screen font-sans text-gray-900">
  <!-- HEADER -->
  <header class="bg-emerald-700 text-white p-4 shadow-md">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" height="32" width="32" viewBox="0 0 640 640"><path fill="#ffffff" d="M112 256C112 167.6 183.6 96 272 96C319.1 96 361.4 116.4 390.7 148.7C401.3 145.6 412.5 144 424 144C490.3 144 544 197.7 544 264C544 277.2 541.9 289.9 537.9 301.8C579.5 322.9 608 366.1 608 416C608 486.7 550.7 544 480 544L176 544C96.5 544 32 479.5 32 400C32 343.2 64.9 294.1 112.7 270.6C112.3 265.8 112 260.9 112 256zM272 144C210.1 144 160 194.1 160 256C160 264.4 160.9 272.6 162.7 280.5C165.4 292.6 158.4 304.8 146.6 308.6C107.9 321 80 357.3 80 400C80 453 123 496 176 496L480 496C524.2 496 560 460.2 560 416C560 378.6 534.3 347.1 499.5 338.4C492 336.5 485.9 331.2 483 324.1C480.1 317 480.9 308.9 485 302.4C492 291.3 496 278.2 496 264.1C496 224.3 463.8 192.1 424 192.1C412.9 192.1 402.5 194.6 393.2 199C382.7 204 370.1 200.7 363.4 191.2C343.1 162.6 309.7 144.1 272.1 144.1z"/></svg>
        <h1 class="text-xl font-bold">Náº¥m Viá»‡t â€” Diá»…n Ä‘Ã n</h1>
      </div>

      <div id="auth-controls" class="flex items-center gap-3">
        <button id="btn-open-register" class="bg-white text-emerald-700 px-3 py-1 rounded shadow">ÄÄƒng kÃ½</button>
        <button id="btn-open-login" class="bg-white text-emerald-700 px-3 py-1 rounded shadow">ÄÄƒng nháº­p</button>
        <button id="btn-logout" class="hidden bg-white text-emerald-700 px-3 py-1 rounded shadow">ÄÄƒng xuáº¥t</button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto p-6 grid grid-cols-1 md:grid-cols-4 gap-6">
    <!-- SIDEBAR -->
    <aside class="md:col-span-1 hidden md:block">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold text-emerald-700 mb-3">Danh má»¥c</h2>
        <ul id="category-list" class="space-y-2 text-sm text-gray-700">
          <!-- sidebar entries will match CATEGORY_MAP keys -->
          <li class="flex items-center gap-2 category-item active" data-category="all"><span>ğŸ“°</span> Táº¥t cáº£ bÃ i viáº¿t</li>
          <li class="flex items-center gap-2 category-item" data-category="growing"><span>ğŸ„</span> Máº¹o trá»“ng</li>
          <li class="flex items-center gap-2 category-item" data-category="identification"><span>ğŸ”¬</span> Nháº­n dáº¡ng</li>
          <li class="flex items-center gap-2 category-item" data-category="cooking"><span>ğŸ³</span> áº¨m thá»±c</li>
          <li class="flex items-center gap-2 category-item" data-category="general"><span>ğŸ’¬</span> Tháº£o luáº­n</li>
        </ul>
      </div>

      <div class="bg-emerald-700 text-white p-4 rounded shadow mt-4">
        <p class="text-sm">ÄÃ£ cÃ³ <span id="stat-users" class="font-semibold">â€”</span> thÃ nh viÃªn</p>
        <p class="text-sm mt-2">Tá»•ng bÃ i viáº¿t: <span id="stat-posts" class="font-semibold">â€”</span></p>
      </div>
    </aside>

    <!-- FEED -->
    <section class="md:col-span-3">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-5xl font-semibold text-gray-200">Báº£ng tin</h1>
        <div class="flex items-center gap-3">
          <input id="searchInput" type="text" placeholder="TÃ¬m chá»§ Ä‘á», tÃ¡c giáº£..." class="px-3 py-2 border rounded" />
          <select id="sortSelect" class="px-3 py-2 border rounded">
            <option value="new">Má»›i nháº¥t</option>
            <option value="popular">Phá»• biáº¿n</option>
          </select>
          <button id="btn-open-create" class="bg-emerald-700 text-white px-3 py-2 rounded shadow hidden md:inline-flex">+ Táº¡o bÃ i</button>
        </div>
      </div>

      <!-- Top category bar (mobile / quick filter) -->
      <div id="category-bar" class="flex flex-wrap gap-2 mb-4">
        <button data-category="all" class="category-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full font-medium">Táº¥t cáº£</button>
        <button data-category="growing" class="category-btn bg-green-100 text-green-700 px-3 py-1 rounded-full font-medium">ğŸ„ Máº¹o Trá»“ng</button>
        <button data-category="identification" class="category-btn bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-medium">ğŸ”¬ Nháº­n Dáº¡ng</button>
        <button data-category="cooking" class="category-btn bg-red-100 text-red-700 px-3 py-1 rounded-full font-medium">ğŸ³ áº¨m Thá»±c</button>
        <button data-category="general" class="category-btn bg-gray-100 text-gray-700 px-3 py-1 rounded-full font-medium">ğŸ’¬ Tháº£o Luáº­n</button>
      </div>

      <div id="feed" class="space-y-4"></div>

      <div class="text-center mt-6">
        <button id="btn-load-more" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Táº£i thÃªm</button>
      </div>
    </section>
  </main>

  <!-- MODALS -->
  <div id="modal-post" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-xl p-6 modal-inner">
      <h3 id="modal-post-title" class="text-lg font-semibold mb-3">Táº¡o bÃ i viáº¿t</h3>
      <form id="form-post" class="space-y-3">
        <input id="post-title" class="w-full border px-3 py-2 rounded" placeholder="TiÃªu Ä‘á»" required />
        <select id="post-category" class="w-full border px-3 py-2 rounded">
          <option value="growing">ğŸ„ Máº¹o Trá»“ng & ChÄƒm SÃ³c</option>
          <option value="identification">ğŸ”¬ Nháº­n Dáº¡ng & PhÃ¢n Loáº¡i</option>
          <option value="cooking">ğŸ³ CÃ´ng Thá»©c & áº¨m Thá»±c</option>
          <option value="general">ğŸ’¬ Tháº£o Luáº­n Chung</option>
        </select>
        <textarea id="post-content" rows="6" class="w-full border px-3 py-2 rounded" placeholder="Ná»™i dung..." required></textarea>
        <div class="flex justify-end gap-2">
          <button type="button" id="btn-cancel-post" class="px-4 py-2 bg-gray-200 rounded">Há»§y</button>
          <button type="submit" class="px-4 py-2 bg-emerald-700 text-white rounded">LÆ°u</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-login" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 modal-inner">
      <h3 class="text-lg font-semibold mb-3">ÄÄƒng nháº­p</h3>
      <form id="form-login" class="space-y-3">
        <input id="login-email" type="email" class="w-full border px-3 py-2 rounded" placeholder="Email" required />
        <input id="login-pass" type="password" class="w-full border px-3 py-2 rounded" placeholder="Máº­t kháº©u" required />
        <div class="flex justify-end gap-2">
          <button type="button" id="btn-cancel-login" class="px-4 py-2 bg-gray-200 rounded">Há»§y</button>
          <button type="submit" class="px-4 py-2 bg-emerald-700 text-white rounded">ÄÄƒng nháº­p</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-register" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 modal-inner">
      <h3 class="text-lg font-semibold mb-3">ÄÄƒng kÃ½</h3>
      <form id="form-register" class="space-y-3">
        <input id="reg-username" type="text" class="w-full border px-3 py-2 rounded" placeholder="TÃªn hiá»ƒn thá»‹" required />
        <input id="reg-email" type="email" class="w-full border px-3 py-2 rounded" placeholder="Email" required />
        <input id="reg-pass" type="password" class="w-full border px-3 py-2 rounded" placeholder="Máº­t kháº©u" required />
        <div class="flex justify-end gap-2">
          <button type="button" id="btn-cancel-register" class="px-4 py-2 bg-gray-200 rounded">Há»§y</button>
          <button type="submit" class="px-4 py-2 bg-emerald-700 text-white rounded">ÄÄƒng kÃ½</button>
        </div>
      </form>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed bottom-6 right-6 hidden z-50">
    <div id="toast-body" class="bg-gray-800 text-white px-4 py-2 rounded shadow"></div>
  </div>

  <!-- SCRIPT -->
  <script>
  /* =========================
     Configuration
     ========================= */
  const API_BASE = window.location.origin + "/api";
  const POSTS_API = API_BASE + "/posts";
  const AUTH_API = API_BASE + "/auth";

  const CATEGORY_MAP = {
    growing: { name: "Máº¹o Trá»“ng & ChÄƒm SÃ³c", color: "bg-green-100 text-green-700", emoji: "ğŸ„" },
    identification: { name: "Nháº­n Dáº¡ng & PhÃ¢n Loáº¡i", color: "bg-blue-100 text-blue-700", emoji: "ğŸ”¬" },
    cooking: { name: "CÃ´ng Thá»©c & áº¨m Thá»±c", color: "bg-red-100 text-red-700", emoji: "ğŸ³" },
    general: { name: "Tháº£o Luáº­n Chung", color: "bg-gray-200 text-gray-700", emoji: "ğŸ’¬" }
  };

  /* =========================
     State
     ========================= */
  let state = {
    posts: [],
    page: 1,
    pageSize: 10,
    token: localStorage.getItem("token") || null,
    editingPostId: null,
    currentCategory: "all",
    currentSearch: ""
  };

  /* =========================
     Utilities
     ========================= */
  function showToast(msg, timeout = 3000) {
    const t = document.getElementById("toast");
    const b = document.getElementById("toast-body");
    b.textContent = msg;
    t.classList.remove("hidden");
    setTimeout(() => t.classList.add("hidden"), timeout);
  }

  function authHeaders() {
    return state.token ? { "Authorization": "Bearer " + state.token } : {};
  }

  function getCategoryDetails(key) {
    return CATEGORY_MAP[key] || { name: "KhÃ´ng xÃ¡c Ä‘á»‹nh", color: "bg-yellow-100 text-yellow-700", emoji: "â“" };
  }

  function escapeHtml(str = "") {
    return String(str).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
  }

  function parseJwt(token) {
    if (!token) return null;
    const parts = token.split(".");
    if (parts.length !== 3) return null;
    try { return JSON.parse(atob(parts[1])); } catch (e) { return null; }
  }

  /* =========================
     Render / Templates
     ========================= */
  function postCardHTML(p) {
    const title = escapeHtml(p.title || "");
    const content = escapeHtml(p.content || "");
    const author = p.author?.username || "áº¨n danh";
    const created = p.createdAt ? new Date(p.createdAt).toLocaleString() : "";
    const likes = Array.isArray(p.likes) ? p.likes.length : 0;
    const comments = Array.isArray(p.comments) ? p.comments.length : 0;
    const category = getCategoryDetails(p.category);

    let actions = "";
    try {
      const payload = parseJwt(state.token);
      if (payload && (payload.id === (p.author?._id || p.author) || payload.role === "admin")) {
        actions = `
          <button data-id="${p._id}" class="btn-edit text-sm text-emerald-700 px-2 py-1 border rounded">Sá»­a</button>
          <button data-id="${p._id}" class="btn-delete text-sm text-red-600 px-2 py-1 border rounded">XÃ³a</button>
        `;
      }
    } catch (e) { /* ignore */ }

    return `
      <article class="bg-white p-5 rounded-lg shadow">
        <div class="flex justify-between items-start">
          <h3 class="text-lg font-semibold">${title}</h3>
          <div class="flex gap-2">${actions}</div>
        </div>
        <span class="inline-block ${category.color} text-xs font-medium px-2.5 py-0.5 rounded-full mt-1">
          ${category.emoji} ${category.name}
        </span>
        <p class="mt-3 text-gray-700 line-clamp-3">${content}</p>
        <div class="mt-4 flex items-center justify-between text-sm text-gray-500">
          <div>ğŸ‘¤ ${author} â€¢ ${created}</div>
          <div class="flex items-center gap-4">
            <div><i class="fa-solid fa-heart"></i> ${likes}</div>
            <div><i class="fa-regular fa-comment"></i> ${comments}</div>
          </div>
        </div>
      </article>
    `;
  }

  function renderFeed() { filterAndRenderFeed(); }

  /* =========================
     Load posts from API
     ========================= */
  async function loadPosts(replace = true) {
    try {
      const categoryParam = state.currentCategory !== 'all' ? `&category=${encodeURIComponent(state.currentCategory)}` : '';
      const url = `${POSTS_API}?page=${state.page}&limit=${state.pageSize}${categoryParam}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("KhÃ´ng thá»ƒ táº£i bÃ i viáº¿t");
      const posts = await res.json();

      // If API doesn't provide category, keep as-is (but here we fallback with random for demo)
      const postsWithCategory = posts.map(p => {
        if (!p.category) {
          const keys = Object.keys(CATEGORY_MAP);
          p.category = keys[Math.floor(Math.random() * keys.length)];
        }
        return p;
      });

      if (replace) state.posts = postsWithCategory;
      else state.posts = state.posts.concat(postsWithCategory);

      document.getElementById("stat-posts").textContent = state.posts.length;
      renderFeed();
    } catch (err) {
      console.error(err);
      showToast("Lá»—i táº£i bÃ i viáº¿t");
    }
  }

  /* =========================
     Filter + render (search + category)
     ========================= */
  function filterAndRenderFeed() {
    const feed = document.getElementById("feed");
    const q = (state.currentSearch || "").toLowerCase().trim();
    const selectedCategory = state.currentCategory || "all";

    let filteredPosts = state.posts.slice();

    // Filter by category
    if (selectedCategory !== "all") {
      filteredPosts = filteredPosts.filter(p => (p.category || "").toLowerCase() === selectedCategory.toLowerCase());
    }

    // Filter by search
    if (q) {
      filteredPosts = filteredPosts.filter(p =>
        ( (p.title || "") + " " + (p.content || "") + " " + (p.author?.username || "") ).toLowerCase().includes(q)
      );
    }

    if (!filteredPosts.length) {
      feed.innerHTML = `<div class="bg-white p-6 rounded shadow text-center text-gray-600">KhÃ´ng tÃ¬m tháº¥y bÃ i viáº¿t nÃ o phÃ¹ há»£p.</div>`;
      return;
    }

    feed.innerHTML = filteredPosts.map(postCardHTML).join("");
  }

  /* =========================
     Category buttons logic (top + sidebar) - keep them in sync
     ========================= */
  function highlightCategoryButtons(categoryKey) {
    // top bar buttons
    document.querySelectorAll("#category-bar .category-btn").forEach(b => {
      b.classList.toggle("ring ring-offset-2 ring-green-400 bg-opacity-90", b.dataset.category === categoryKey);
    });
    // sidebar items
    document.querySelectorAll(".category-item").forEach(li => {
      li.classList.toggle("active", li.dataset.category === categoryKey);
    });
  }

  function initCategoryControls() {
    // top bar
    document.querySelectorAll("#category-bar .category-btn").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const category = btn.dataset.category || "all";
        if (category === state.currentCategory) return;
        state.currentCategory = category;
        state.page = 1;
        highlightCategoryButtons(category);
        await loadPosts(true); // fetch category-specific page
      });
    });

    // sidebar
    document.querySelectorAll(".category-item").forEach(li => {
      li.addEventListener("click", async (e) => {
        const category = li.dataset.category || "all";
        if (category === state.currentCategory) return;
        state.currentCategory = category;
        state.page = 1;
        highlightCategoryButtons(category);
        await loadPosts(true);
      });
    });

    // initial highlight
    highlightCategoryButtons(state.currentCategory);
  }

  /* =========================
     Create / Edit posts
     ========================= */
  function openCreateModal() {
    state.editingPostId = null;
    document.getElementById("modal-post").classList.remove("hidden");
    document.getElementById("modal-post-title").textContent = "Táº¡o bÃ i viáº¿t";
    document.getElementById("post-title").value = "";
    document.getElementById("post-content").value = "";
    document.getElementById("post-category").value = state.currentCategory === "all" ? "general" : state.currentCategory;
  }

  function openEditModal(post) {
    state.editingPostId = post._id;
    document.getElementById("modal-post").classList.remove("hidden");
    document.getElementById("modal-post-title").textContent = "Chá»‰nh sá»­a bÃ i viáº¿t";
    document.getElementById("post-title").value = post.title || "";
    document.getElementById("post-content").value = post.content || "";
    document.getElementById("post-category").value = post.category || "general";
  }

  document.getElementById("btn-open-create").addEventListener("click", openCreateModal);
  document.getElementById("btn-cancel-post").addEventListener("click", () => document.getElementById("modal-post").classList.add("hidden"));

  document.getElementById("form-post").addEventListener("submit", async (e) => {
    e.preventDefault();
    const title = document.getElementById("post-title").value.trim();
    const content = document.getElementById("post-content").value.trim();
    const category = document.getElementById("post-category").value;

    if (!title || !content) { showToast("Vui lÃ²ng Ä‘iá»n tiÃªu Ä‘á» vÃ  ná»™i dung"); return; }
    if (!state.token) { showToast("Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ táº¡o bÃ i"); return; }

    try {
      const postData = { title, content, category };
      let res;
      if (state.editingPostId) {
        res = await fetch(`${POSTS_API}/${state.editingPostId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify(postData)
        });
      } else {
        res = await fetch(POSTS_API, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify(postData)
        });
      }
      const data = await res.json();
      if (!res.ok) { showToast(data.message || "Lá»—i server"); return; }
      document.getElementById("modal-post").classList.add("hidden");
      showToast(state.editingPostId ? "Cáº­p nháº­t bÃ i thÃ nh cÃ´ng" : "Táº¡o bÃ i thÃ nh cÃ´ng");
      state.page = 1;
      await loadPosts(true);
    } catch (err) {
      console.error(err);
      showToast("Lá»—i khi gá»­i bÃ i");
    }
  });

  /* =========================
     Delete / Edit handlers (delegation)
     ========================= */
  document.addEventListener("click", async (ev) => {
    const btn = ev.target;

    if (btn.matches(".btn-delete")) {
      const id = btn.dataset.id;
      if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a bÃ i nÃ y?")) return;
      try {
        const res = await fetch(`${POSTS_API}/${id}`, { method: "DELETE", headers: { ...authHeaders() } });
        const data = await res.json();
        if (!res.ok) { showToast(data.message || "KhÃ´ng thá»ƒ xÃ³a"); return; }
        showToast("ÄÃ£ xÃ³a bÃ i");
        state.page = 1;
        await loadPosts(true);
      } catch (err) {
        console.error(err);
        showToast("Lá»—i khi xÃ³a bÃ i");
      }
    }

    if (btn.matches(".btn-edit")) {
      const id = btn.dataset.id;
      const post = state.posts.find(p => p._id === id);
      if (!post) { showToast("BÃ i khÃ´ng tá»“n táº¡i"); return; }
      openEditModal(post);
    }
  });

  /* =========================
     Auth (login/register/logout)
     ========================= */
  document.getElementById("btn-open-login").addEventListener("click", () => document.getElementById("modal-login").classList.remove("hidden"));
  document.getElementById("btn-cancel-login").addEventListener("click", () => document.getElementById("modal-login").classList.add("hidden"));
  document.getElementById("btn-open-register").addEventListener("click", () => document.getElementById("modal-register").classList.remove("hidden"));
  document.getElementById("btn-cancel-register").addEventListener("click", () => document.getElementById("modal-register").classList.add("hidden"));

  document.getElementById("form-login").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("login-email").value;
    const password = document.getElementById("login-pass").value;
    try {
      const res = await fetch(`${AUTH_API}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();
      if (!res.ok) { showToast(data.message || "ÄÄƒng nháº­p tháº¥t báº¡i"); return; }
      const token = data.token;
      state.token = token;
      localStorage.setItem("token", token);
      document.getElementById("modal-login").classList.add("hidden");
      updateAuthUI();
      showToast("ÄÄƒng nháº­p thÃ nh cÃ´ng");
    } catch (err) {
      console.error(err);
      showToast("Lá»—i khi Ä‘Äƒng nháº­p");
    }
  });

  document.getElementById("form-register").addEventListener("submit", async (e) => {
    e.preventDefault();
    const username = document.getElementById("reg-username").value;
    const email = document.getElementById("reg-email").value;
    const password = document.getElementById("reg-pass").value;
    try {
      const res = await fetch(`${AUTH_API}/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, email, password })
      });
      const data = await res.json();
      if (!res.ok) { showToast(data.message || "ÄÄƒng kÃ½ tháº¥t báº¡i"); return; }
      const token = data.token;
      state.token = token;
      localStorage.setItem("token", token);
      document.getElementById("modal-register").classList.add("hidden");
      updateAuthUI();
      showToast("ÄÄƒng kÃ½ thÃ nh cÃ´ng");
    } catch (err) {
      console.error(err);
      showToast("Lá»—i khi Ä‘Äƒng kÃ½");
    }
  });

  document.getElementById("btn-logout").addEventListener("click", () => {
    localStorage.removeItem("token");
    state.token = null;
    updateAuthUI();
    showToast("ÄÃ£ Ä‘Äƒng xuáº¥t");
  });

  function updateAuthUI() {
    const loggedIn = !!state.token;
    document.getElementById("btn-open-login").classList.toggle("hidden", loggedIn);
    document.getElementById("btn-open-register").classList.toggle("hidden", loggedIn);
    document.getElementById("btn-logout").classList.toggle("hidden", !loggedIn);
    document.getElementById("btn-open-create").classList.toggle("hidden", !loggedIn);
  }

  /* =========================
     Init + handlers (search, load more, backdrop close)
     ========================= */
  (function init() {
    updateAuthUI();
    initCategoryControls();

    // initial load
    loadPosts(true);

    // load more
    document.getElementById("btn-load-more").addEventListener("click", async () => {
      state.page++;
      await loadPosts(false);
    });

    // search handler (live)
    document.getElementById("searchInput").addEventListener("input", (e) => {
      state.currentSearch = e.target.value.trim();
      filterAndRenderFeed();
    });

    // close modals when clicking backdrop
    document.querySelectorAll('[id^="modal-"]').forEach(mod => {
      mod.addEventListener("click", (ev) => {
        if (ev.target === mod) mod.classList.add("hidden");
      });
    });
  })();

  </script>
</body>
</html>
